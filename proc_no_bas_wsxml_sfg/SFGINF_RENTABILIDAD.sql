USE SFGPRODU;
--  DDL for Package Body SFGINF_RENTABILIDAD
--------------------------------------------------------

  /* PACKAGE BODY WSXML_SFG.SFGINF_RENTABILIDAD */ 


  IF OBJECT_ID('WSXML_SFG.SFGINF_RENTABILIDAD_GetRentabilidadDetalle', 'P') IS NOT NULL
  DROP PROCEDURE WSXML_SFG.SFGINF_RENTABILIDAD_GetRentabilidadDetalle;
GO

CREATE     PROCEDURE WSXML_SFG.SFGINF_RENTABILIDAD_GetRentabilidadDetalle(@p_CODCICLOFACTURACIONPDV NUMERIC(22,0),
                                   @p_CODLINEADENEGOCIO      NUMERIC(22,0),
                                   @pg_CADENA                NVARCHAR(2000),
                                   @pg_ALIADOESTRATEGICO     NVARCHAR(2000),
                                   @pg_PRODUCTO              NVARCHAR(2000)) AS
 BEGIN
    DECLARE @sFECHACCLO DATETIME;
    DECLARE @sFECHAFRST DATETIME;
    DECLARE @sFECHALAST DATETIME;
    DECLARE @vTOTALMIXV FLOAT = 0;
   
  SET NOCOUNT ON;
    SELECT @sFECHACCLO = FECHAEJECUCION FROM WSXML_SFG.CICLOFACTURACIONPDV WHERE ID_CICLOFACTURACIONPDV = @p_CODCICLOFACTURACIONPDV;
    EXEC WSXML_SFG.SFG_PACKAGE_GetMonthRange @sFECHACCLO, @sFECHAFRST OUT, @sFECHALAST OUT
    -- Get total amount for % participation
    SELECT @vTOTALMIXV = SUM(CASE WHEN REG.CODTIPOREGISTRO IN (1, 3) THEN REG.NUMTRANSACCIONES
                    WHEN REG.CODTIPOREGISTRO = 2       THEN REG.NUMTRANSACCIONES * (-1) ELSE 0 END) FROM WSXML_SFG.ENTRADAARCHIVOCONTROL CTR
    INNER JOIN WSXML_SFG.REGISTROFACTURACION REG ON (REG.CODENTRADAARCHIVOCONTROL = CTR.ID_ENTRADAARCHIVOCONTROL)
    INNER JOIN WSXML_SFG.PRODUCTO            PRD ON (PRD.ID_PRODUCTO              = REG.CODPRODUCTO)
    INNER JOIN WSXML_SFG.TIPOPRODUCTO        TPR ON (TPR.ID_TIPOPRODUCTO          = PRD.CODTIPOPRODUCTO)
    WHERE CTR.REVERSADO = 0 AND CTR.FECHAARCHIVO BETWEEN @sFECHAFRST AND @sFECHALAST
      AND TPR.CODLINEADENEGOCIO = CASE WHEN @p_CODLINEADENEGOCIO = -1 THEN TPR.CODLINEADENEGOCIO ELSE @p_CODLINEADENEGOCIO END;
    -- Open cursor
          SELECT AGRUPACIONPUNTODEVENTA.CODIGOAGRUPACIONGTECH AS CODIGOAGRUPACIONGTECH,
             PUNTODEVENTA.CODIGOGTECHPUNTODEVENTA AS CODIGOGTECHPUNTODEVENTA,
             PUNTODEVENTA.NUMEROTERMINAL AS NUMEROTERMINAL,
             REDPDV.NOMREDPDV AS NOMREDPDV,
             TIPONEGOCIO.NOMTIPONEGOCIO AS NOMTIPONEGOCIO,
             REGIONAL.NOMREGIONAL        AS NOMREGIONAL,
             isnull(FMR.NOMFMR, ' ')                  AS NOMFMR,
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROFACTURACION.NUMTRANSACCIONES 
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  THEN REGISTROFACTURACION.NUMTRANSACCIONES *-1 
                       ELSE 0 END ), 4),0)                                                                                            AS NUMTRANSACCIONES,
             Isnull(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROFACTURACION.NUMTRANSACCIONES 
                                 WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (2) THEN REGISTROFACTURACION.NUMTRANSACCIONES *-1 
                                 ELSE 0 END )  * 100 / @vTOTALMIXV, 4),0)                                                          AS PRTTRANSACCIONES,                         
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROFACTURACION.VALORVENTABRUTA 
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  THEN REGISTROFACTURACION.VALORVENTABRUTA *-1 
                       ELSE 0 END ) , 4),0)                                                                                           AS INGRESOSBRUTOS,                                                                    

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN IMPUESTOS.IVA 
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  THEN IMPUESTOS.IVA *-1 
                       ELSE 0 END ), 4),0)    AS IVAPRODUCTO,
                         
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROFACTURACION.VALORDESCUENTOS 

                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  THEN REGISTROFACTURACION.VALORDESCUENTOS *-1 
                       ELSE 0 END ) , 4),0)                                                                                           AS DESCUENTOS,                                                                     

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) 
                                AND REGISTROFACTURACION.COMISIONANTICIPO = 0  THEN REGISTROFACTURACION.VALORCOMISION 
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  
                                AND REGISTROFACTURACION.COMISIONANTICIPO = 0  THEN REGISTROFACTURACION.VALORCOMISION  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS COMISION,       
                                                                                      
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3)  THEN REGISTROREVENUE.REVENUEBASE
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)       THEN REGISTROREVENUE.REVENUEBASE  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS REVENUEBASE,                          


             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3)  THEN REVENUETRX.REVENUE
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)       THEN REVENUETRX.REVENUE  *-1 
                       ELSE 0 END ), 4),0)                                                                                      AS REVENUERANGOS,                          
                                                
                       
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3)  THEN REVENUEFIJO.REVENUE
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)       THEN REVENUEFIJO.REVENUE  *-1 
                       ELSE 0 END ), 4),0)                                                                                            AS REVENUEFIJO,           
                  
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3)  THEN REGISTROREVENUE.REVENUETOTAL
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)       THEN REGISTROREVENUE.REVENUETOTAL  *-1 
                       ELSE 0 END ), 4),0)                                                                                            AS REVENUETOTAL,                                
                         
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROREVENUE.INGRESOCORPORATIVO
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN REGISTROREVENUE.INGRESOCORPORATIVO  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS REVENUECORPORATIVO,                          

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROREVENUE.INGRESOLOCAL
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN REGISTROREVENUE.INGRESOLOCAL  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS REVENUELOCAL,                                                   

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROREVENUE.EGRESOLOCAL
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN REGISTROREVENUE.EGRESOLOCAL  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS COSTODEVENTA,                                                   

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO01
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO01  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS ICA,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO04
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO04  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS COMISIONETESA,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO02
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO02  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS INTERCOMPANY,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO03
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO03  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS ICAINTERCOMPANY,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO07
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO07  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS BADDEBTPROVISION,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) 
                           THEN ISNULL(COSTOSCALCULADOS.COSTO05,0)+ISNULL(COSTOSCALCULADOS.COSTO06,0)
                           WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      
                           THEN (ISNULL(COSTOSCALCULADOS.COSTO05,0)+ISNULL(COSTOSCALCULADOS.COSTO06,0))  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS MERCADEO,
                         
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO08
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO08  *-1 
                       ELSE 0 END ), 4),0)                                                                                       AS IVANODESCONTABLE,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO09
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO09  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS IC108,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO10
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO10  *-1 
                       ELSE 0 END ), 4),0)                                                                                        AS ICAIC108,
                         
            ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO11
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO11  *-1 
                       ELSE 0 END ), 4),0)                                                                                        AS COSTOSINBIOMETRIA,
                         
                       ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO12
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO12  *-1 
                       ELSE 0 END ), 4),0)                                                                                        AS COSTOCONBIOMETRIA,
                         
                       ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO13
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO13  *-1 
                       ELSE 0 END ), 4),0)                                                                                       AS COSTOSINBIOMETRIACONSULTA,
                         
                       ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO14
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO14  *-1 
                       ELSE 0 END ), 4),0)                                                                                       AS COSTODATACREDITO,
                       
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROREVENUE.UTILIDADPARCIAL
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN REGISTROREVENUE.UTILIDADPARCIAL  *-1 
                       ELSE 0 END ), 4),0)          AS  UTILIDADPARCIAL
      FROM WSXML_SFG.REGISTROREVENUE
      INNER JOIN WSXML_SFG.REGISTROFACTURACION ON REGISTROREVENUE.CODREGISTROFACTURACION = REGISTROFACTURACION.ID_REGISTROFACTURACION
      INNER JOIN WSXML_SFG.ENTRADAARCHIVOCONTROL ON REGISTROFACTURACION.CODENTRADAARCHIVOCONTROL = ENTRADAARCHIVOCONTROL.ID_ENTRADAARCHIVOCONTROL
      INNER JOIN WSXML_SFG.PUNTODEVENTA ON REGISTROFACTURACION.CODPUNTODEVENTA = PUNTODEVENTA.ID_PUNTODEVENTA
      INNER JOIN WSXML_SFG.AGRUPACIONPUNTODEVENTA ON REGISTROFACTURACION.CODAGRUPACIONPUNTODEVENTA = AGRUPACIONPUNTODEVENTA.ID_AGRUPACIONPUNTODEVENTA
      INNER JOIN WSXML_SFG.TIPONEGOCIO ON PUNTODEVENTA.CODTIPONEGOCIO = TIPONEGOCIO.ID_TIPONEGOCIO
      INNER JOIN WSXML_SFG.REGIONAL ON PUNTODEVENTA.CODREGIONAL = REGIONAL.ID_REGIONAL
      INNER JOIN WSXML_SFG.PRODUCTO ON REGISTROFACTURACION.CODPRODUCTO = PRODUCTO.ID_PRODUCTO 
      INNER JOIN WSXML_SFG.TIPOPRODUCTO ON PRODUCTO.CODTIPOPRODUCTO = TIPOPRODUCTO.ID_TIPOPRODUCTO
      LEFT OUTER JOIN WSXML_SFG.RUTAPDV ON PUNTODEVENTA.CODRUTAPDV = RUTAPDV.ID_RUTAPDV
      LEFT OUTER JOIN WSXML_SFG.FMR ON RUTAPDV.CODFMR = FMR.ID_FMR
      LEFT OUTER JOIN WSXML_SFG.REDPDV ON REGISTROFACTURACION.CODREDPDV = REDPDV.ID_REDPDV
      LEFT OUTER JOIN 
                      (
                      SELECT CODREGISTROFACTURACION,
                             SUM(CASE WHEN CODIMPUESTO = 1 THEN IMPUESTOREGFACTURACION.VALORIMPUESTO ELSE 0 END) AS IVA 
                      FROM WSXML_SFG.IMPUESTOREGFACTURACION
                      GROUP BY CODREGISTROFACTURACION 
                      )IMPUESTOS ON IMPUESTOS.CODREGISTROFACTURACION = REGISTROFACTURACION.ID_REGISTROFACTURACION
      LEFT OUTER JOIN (
                      SELECT CODREGISTROREVENUE, SUM(REVENUE) AS REVENUE
                      FROM WSXML_SFG.REGISTROREVENUETRANSACCION
                      GROUP BY CODREGISTROREVENUE
                      ) REVENUETRX ON REVENUETRX.CODREGISTROREVENUE = REGISTROREVENUE.ID_REGISTROREVENUE              
      LEFT OUTER JOIN (
                 SELECT CODREGISTROREVENUE, SUM(REVENUE) AS REVENUE
                 FROM WSXML_SFG.REGISTROREVENUEINCENTIVO
                 GROUP BY CODREGISTROREVENUE
                 ) REVENUEFIJO ON REVENUEFIJO.CODREGISTROREVENUE = REGISTROREVENUE.ID_REGISTROREVENUE
      LEFT OUTER JOIN (SELECT CODREGISTROREVENUE,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 41 OR CODCOSTOCALCULADO = 42 THEN VALORCOSTO ELSE 0 END) AS COSTO01,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 43 THEN VALORCOSTO ELSE 0 END) AS COSTO02,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 44 THEN VALORCOSTO ELSE 0 END) AS COSTO03,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 45 OR CODCOSTOCALCULADO = 46 THEN VALORCOSTO ELSE 0 END) AS COSTO04,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 47 THEN VALORCOSTO ELSE 0 END) AS COSTO05,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 48 THEN VALORCOSTO ELSE 0 END) AS COSTO06,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 49 OR CODCOSTOCALCULADO = 50 THEN VALORCOSTO ELSE 0 END) AS COSTO07,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 51 OR CODCOSTOCALCULADO = 54 THEN VALORCOSTO ELSE 0 END) AS COSTO08,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 52 THEN VALORCOSTO ELSE 0 END) AS COSTO09,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 53 THEN VALORCOSTO ELSE 0 END) AS COSTO10,
                        SUM(CASE WHEN CODCOSTOCALCULADO=67 OR CODCOSTOCALCULADO=68 THEN VALORCOSTO ELSE 0 END) AS COSTO11, -- COSTO SIN BIOMETRIA
                        SUM(CASE WHEN CODCOSTOCALCULADO=65 OR CODCOSTOCALCULADO=66 THEN VALORCOSTO ELSE 0 END) AS COSTO12, -- COSTO CON BIOMETRIA
                        SUM(CASE WHEN CODCOSTOCALCULADO=71 OR CODCOSTOCALCULADO=72 THEN VALORCOSTO ELSE 0 END) AS COSTO13, -- COSTO CON BIOMETRIA CONSULTA
                        SUM(CASE WHEN CODCOSTOCALCULADO=69 OR CODCOSTOCALCULADO=70 THEN VALORCOSTO ELSE 0 END) AS COSTO14 -- COSTO DATACREDITO
                 FROM WSXML_SFG.REGISTROREVCOSTOCALCULADO
                 GROUP BY CODREGISTROREVENUE) COSTOSCALCULADOS ON COSTOSCALCULADOS.CODREGISTROREVENUE = REGISTROREVENUE.ID_REGISTROREVENUE
      WHERE ENTRADAARCHIVOCONTROL.FECHAARCHIVO BETWEEN @sFECHAFRST AND @sFECHALAST
        AND TIPOPRODUCTO.CODLINEADENEGOCIO = CASE WHEN @p_CODLINEADENEGOCIO = -1 THEN TIPOPRODUCTO.CODLINEADENEGOCIO ELSE @p_CODLINEADENEGOCIO END
      GROUP BY     AGRUPACIONPUNTODEVENTA.CODIGOAGRUPACIONGTECH,
             PUNTODEVENTA.CODIGOGTECHPUNTODEVENTA,
             PUNTODEVENTA.NUMEROTERMINAL,
             REDPDV.NOMREDPDV,
             TIPONEGOCIO.NOMTIPONEGOCIO,
             REGIONAL.NOMREGIONAL,
             FMR.NOMFMR       
      ORDER BY 1;
  END;
  GO
  

  IF OBJECT_ID('WSXML_SFG.SFGINF_RENTABILIDAD_GetRentabilidadDetalleAcumulad', 'P') IS NOT NULL
  DROP PROCEDURE WSXML_SFG.SFGINF_RENTABILIDAD_GetRentabilidadDetalleAcumulad;
GO

CREATE     PROCEDURE WSXML_SFG.SFGINF_RENTABILIDAD_GetRentabilidadDetalleAcumulad(@p_CODCICLOFACTURACIONPDV NUMERIC(22,0),
                                           @p_CODLINEADENEGOCIO      NUMERIC(22,0),
                                           @pg_CADENA                NVARCHAR(2000),
                                           @pg_ALIADOESTRATEGICO     NVARCHAR(2000),
                                           @pg_PRODUCTO              NVARCHAR(2000)) AS
 BEGIN
    DECLARE @sFECHACCLO DATETIME;
    DECLARE @sFECHAFRST DATETIME;
    DECLARE @sFECHALAST DATETIME;
    DECLARE @vTOTALMIXV FLOAT = 0;
   
  SET NOCOUNT ON;
    SELECT @sFECHACCLO = FECHAEJECUCION FROM WSXML_SFG.CICLOFACTURACIONPDV WHERE ID_CICLOFACTURACIONPDV = @p_CODCICLOFACTURACIONPDV;
    EXEC WSXML_SFG.SFG_PACKAGE_GetMonthRange @sFECHACCLO, @sFECHAFRST OUT, @sFECHALAST OUT
    -- Get total amount for % participation
    SELECT @vTOTALMIXV = SUM(CASE WHEN REG.CODTIPOREGISTRO IN (1, 3) THEN REG.NUMTRANSACCIONES
                    WHEN REG.CODTIPOREGISTRO = 2       THEN REG.NUMTRANSACCIONES * (-1) ELSE 0 END) FROM WSXML_SFG.ENTRADAARCHIVOCONTROL CTR
    INNER JOIN WSXML_SFG.REGISTROFACTURACION REG ON (REG.CODENTRADAARCHIVOCONTROL = CTR.ID_ENTRADAARCHIVOCONTROL)
    INNER JOIN WSXML_SFG.PRODUCTO            PRD ON (PRD.ID_PRODUCTO              = REG.CODPRODUCTO)
    INNER JOIN WSXML_SFG.TIPOPRODUCTO        TPR ON (TPR.ID_TIPOPRODUCTO          = PRD.CODTIPOPRODUCTO)
    WHERE CTR.REVERSADO = 0 AND CTR.FECHAARCHIVO BETWEEN CONVERT(DATETIME,FORMAT(@sFECHAFRST, 'yyyy')+'-01-01', 103) AND @sFECHALAST
      AND TPR.CODLINEADENEGOCIO = CASE WHEN @p_CODLINEADENEGOCIO = -1 THEN TPR.CODLINEADENEGOCIO ELSE @p_CODLINEADENEGOCIO END;
    -- Open cursor
         SELECT AGRUPACIONPUNTODEVENTA.CODIGOAGRUPACIONGTECH AS CODIGOAGRUPACIONGTECH,
             PUNTODEVENTA.CODIGOGTECHPUNTODEVENTA AS CODIGOGTECHPUNTODEVENTA,
             PUNTODEVENTA.NUMEROTERMINAL AS NUMEROTERMINAL,
             REDPDV.NOMREDPDV AS NOMREDPDV,
             TIPONEGOCIO.NOMTIPONEGOCIO AS NOMTIPONEGOCIO,
             REGIONAL.NOMREGIONAL        AS NOMREGIONAL,
             isnull(FMR.NOMFMR, ' ')                  AS NOMFMR,
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROFACTURACION.NUMTRANSACCIONES 
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  THEN REGISTROFACTURACION.NUMTRANSACCIONES *-1 
                       ELSE 0 END ), 4),0)                                                                                            AS NUMTRANSACCIONES,
             Isnull(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROFACTURACION.NUMTRANSACCIONES 
                                 WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (2) THEN REGISTROFACTURACION.NUMTRANSACCIONES *-1 
                                 ELSE 0 END )  * 100 / @vTOTALMIXV, 4),0)                                                          AS PRTTRANSACCIONES,                         
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROFACTURACION.VALORVENTABRUTA 
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  THEN REGISTROFACTURACION.VALORVENTABRUTA *-1 
                       ELSE 0 END ) , 4),0)                                                                                           AS INGRESOSBRUTOS,                                                                    

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN IMPUESTOS.IVA 
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  THEN IMPUESTOS.IVA *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS IVAPRODUCTO,                                                                    

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROFACTURACION.VALORDESCUENTOS 
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  THEN REGISTROFACTURACION.VALORDESCUENTOS *-1 
                       ELSE 0 END ) , 4),0)                                                                                           AS DESCUENTOS,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) 
                                AND REGISTROFACTURACION.COMISIONANTICIPO = 0  THEN REGISTROFACTURACION.VALORCOMISION 
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  
                                AND REGISTROFACTURACION.COMISIONANTICIPO = 0  THEN REGISTROFACTURACION.VALORCOMISION  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS COMISION,       
                                                                                      
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3)  THEN REGISTROREVENUE.REVENUEBASE
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)       THEN REGISTROREVENUE.REVENUEBASE  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS REVENUEBASE,                          


             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3)  THEN REVENUETRX.REVENUE
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)       THEN REVENUETRX.REVENUE  *-1 
                       ELSE 0 END ), 4),0)                                                                                      AS REVENUERANGOS,                          
                                                
                       
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3)  THEN REVENUEFIJO.REVENUE
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)       THEN REVENUEFIJO.REVENUE  *-1 
                       ELSE 0 END ), 4),0)                                                                                            AS REVENUEFIJO,           
                  
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3)  THEN REGISTROREVENUE.REVENUETOTAL
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)       THEN REGISTROREVENUE.REVENUETOTAL  *-1 
                       ELSE 0 END ), 4),0)                                                                                            AS REVENUETOTAL,                                
                         
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROREVENUE.INGRESOCORPORATIVO
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN REGISTROREVENUE.INGRESOCORPORATIVO  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS REVENUECORPORATIVO,                          

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROREVENUE.INGRESOLOCAL
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN REGISTROREVENUE.INGRESOLOCAL  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS REVENUELOCAL,                                                   

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROREVENUE.EGRESOLOCAL
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN REGISTROREVENUE.EGRESOLOCAL  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS COSTODEVENTA,                                                   

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO01
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO01  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS ICA,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO04
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO04  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS COMISIONETESA,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO02
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO02  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS INTERCOMPANY,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO03
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO03  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS ICAINTERCOMPANY,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO07
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO07  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS BADDEBTPROVISION,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) 
                           THEN ISNULL(COSTOSCALCULADOS.COSTO05,0)+ISNULL(COSTOSCALCULADOS.COSTO06,0)
                           WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      
                           THEN (ISNULL(COSTOSCALCULADOS.COSTO05,0)+ISNULL(COSTOSCALCULADOS.COSTO06,0))  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS MERCADEO,
                         
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO08
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO08  *-1 
                       ELSE 0 END ), 4),0)                                                                                       AS IVANODESCONTABLE,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO09
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO09  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS IC108,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO10
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO10  *-1 
                       ELSE 0 END ), 4),0)                                                                                        AS ICAIC108,
                         
                       ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO11
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO11  *-1 
                       ELSE 0 END ), 4),0)                                                                                        AS COSTOSINBIOMETRIA,
                         
                       ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO12
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO12  *-1 
                       ELSE 0 END ), 4),0)                                                                                        AS COSTOCONBIOMETRIA,
                         
                       ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO13
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO13  *-1 
                       ELSE 0 END ), 4),0)                                                                                       AS COSTOSINBIOMETRIACONSULTA,
                         
                       ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO14
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO14  *-1 
                       ELSE 0 END ), 4),0)                                                                                       AS COSTODATACREDITO,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROREVENUE.UTILIDADPARCIAL
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN REGISTROREVENUE.UTILIDADPARCIAL  *-1 
                       ELSE 0 END ), 4),0)    AS  UTILIDADPARCIAL
      
      FROM WSXML_SFG.REGISTROREVENUE
      INNER JOIN WSXML_SFG.REGISTROFACTURACION ON REGISTROREVENUE.CODREGISTROFACTURACION = REGISTROFACTURACION.ID_REGISTROFACTURACION
      INNER JOIN WSXML_SFG.ENTRADAARCHIVOCONTROL ON REGISTROFACTURACION.CODENTRADAARCHIVOCONTROL = ENTRADAARCHIVOCONTROL.ID_ENTRADAARCHIVOCONTROL
      INNER JOIN WSXML_SFG.PUNTODEVENTA ON REGISTROFACTURACION.CODPUNTODEVENTA = PUNTODEVENTA.ID_PUNTODEVENTA
      INNER JOIN WSXML_SFG.AGRUPACIONPUNTODEVENTA ON REGISTROFACTURACION.CODAGRUPACIONPUNTODEVENTA = AGRUPACIONPUNTODEVENTA.ID_AGRUPACIONPUNTODEVENTA
      INNER JOIN WSXML_SFG.TIPONEGOCIO ON PUNTODEVENTA.CODTIPONEGOCIO = TIPONEGOCIO.ID_TIPONEGOCIO
      INNER JOIN WSXML_SFG.REGIONAL ON PUNTODEVENTA.CODREGIONAL = REGIONAL.ID_REGIONAL
      INNER JOIN WSXML_SFG.PRODUCTO ON REGISTROFACTURACION.CODPRODUCTO = PRODUCTO.ID_PRODUCTO 
      INNER JOIN WSXML_SFG.TIPOPRODUCTO ON PRODUCTO.CODTIPOPRODUCTO = TIPOPRODUCTO.ID_TIPOPRODUCTO
      LEFT OUTER JOIN WSXML_SFG.RUTAPDV ON PUNTODEVENTA.CODRUTAPDV = RUTAPDV.ID_RUTAPDV
      LEFT OUTER JOIN WSXML_SFG.FMR ON RUTAPDV.CODFMR = FMR.ID_FMR
      LEFT OUTER JOIN WSXML_SFG.REDPDV ON REGISTROFACTURACION.CODREDPDV = REDPDV.ID_REDPDV
      LEFT OUTER JOIN 
                      (
                      SELECT CODREGISTROFACTURACION,
                             SUM(CASE WHEN CODIMPUESTO = 1 THEN IMPUESTOREGFACTURACION.VALORIMPUESTO ELSE 0 END) AS IVA 
                      FROM WSXML_SFG.IMPUESTOREGFACTURACION
                      GROUP BY CODREGISTROFACTURACION 
                      )IMPUESTOS ON IMPUESTOS.CODREGISTROFACTURACION = REGISTROFACTURACION.ID_REGISTROFACTURACION
      LEFT OUTER JOIN (
                      SELECT CODREGISTROREVENUE, SUM(REVENUE) AS REVENUE
                      FROM WSXML_SFG.REGISTROREVENUETRANSACCION
                      GROUP BY CODREGISTROREVENUE
                      ) REVENUETRX ON REVENUETRX.CODREGISTROREVENUE = REGISTROREVENUE.ID_REGISTROREVENUE              
      LEFT OUTER JOIN (
                 SELECT CODREGISTROREVENUE, SUM(REVENUE) AS REVENUE
                 FROM WSXML_SFG.REGISTROREVENUEINCENTIVO
                 GROUP BY CODREGISTROREVENUE
                 ) REVENUEFIJO ON REVENUEFIJO.CODREGISTROREVENUE = REGISTROREVENUE.ID_REGISTROREVENUE
      LEFT OUTER JOIN (SELECT CODREGISTROREVENUE,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 41 OR CODCOSTOCALCULADO = 42 THEN VALORCOSTO ELSE 0 END) AS COSTO01,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 43 THEN VALORCOSTO ELSE 0 END) AS COSTO02,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 44 THEN VALORCOSTO ELSE 0 END) AS COSTO03,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 45 OR CODCOSTOCALCULADO = 46 THEN VALORCOSTO ELSE 0 END) AS COSTO04,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 47 THEN VALORCOSTO ELSE 0 END) AS COSTO05,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 48 THEN VALORCOSTO ELSE 0 END) AS COSTO06,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 49 OR CODCOSTOCALCULADO = 50 THEN VALORCOSTO ELSE 0 END) AS COSTO07,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 51 OR CODCOSTOCALCULADO = 54 THEN VALORCOSTO ELSE 0 END) AS COSTO08,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 52 THEN VALORCOSTO ELSE 0 END) AS COSTO09,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 53 THEN VALORCOSTO ELSE 0 END) AS COSTO10,
                        SUM(CASE WHEN CODCOSTOCALCULADO=67 OR CODCOSTOCALCULADO=68 THEN VALORCOSTO ELSE 0 END) AS COSTO11, -- COSTO SIN BIOMETRIA
                        SUM(CASE WHEN CODCOSTOCALCULADO=65 OR CODCOSTOCALCULADO=66 THEN VALORCOSTO ELSE 0 END) AS COSTO12, -- COSTO CON BIOMETRIA
                        SUM(CASE WHEN CODCOSTOCALCULADO=71 OR CODCOSTOCALCULADO=72 THEN VALORCOSTO ELSE 0 END) AS COSTO13, -- COSTO CON BIOMETRIA CONSULTA
                        SUM(CASE WHEN CODCOSTOCALCULADO=69 OR CODCOSTOCALCULADO=70 THEN VALORCOSTO ELSE 0 END) AS COSTO14 -- COSTO DATACREDITO
                 FROM WSXML_SFG.REGISTROREVCOSTOCALCULADO
                 GROUP BY CODREGISTROREVENUE) COSTOSCALCULADOS ON COSTOSCALCULADOS.CODREGISTROREVENUE = REGISTROREVENUE.ID_REGISTROREVENUE
      WHERE ENTRADAARCHIVOCONTROL.FECHAARCHIVO BETWEEN CONVERT(DATETIME, FORMAT(@sFECHAFRST, 'yyyy')+'-01-01',103) AND @sFECHALAST
        AND TIPOPRODUCTO.CODLINEADENEGOCIO = CASE WHEN @p_CODLINEADENEGOCIO = -1 THEN TIPOPRODUCTO.CODLINEADENEGOCIO ELSE @p_CODLINEADENEGOCIO END
          GROUP BY     AGRUPACIONPUNTODEVENTA.CODIGOAGRUPACIONGTECH,
             PUNTODEVENTA.CODIGOGTECHPUNTODEVENTA,
             PUNTODEVENTA.NUMEROTERMINAL,
             REDPDV.NOMREDPDV,
             TIPONEGOCIO.NOMTIPONEGOCIO,
             REGIONAL.NOMREGIONAL,
             FMR.NOMFMR       
      ORDER BY 1;
  END;
GO


 
  IF OBJECT_ID('WSXML_SFG.SFGINF_RENTABILIDAD_GetRentabilidadServicio', 'P') IS NOT NULL
  DROP PROCEDURE WSXML_SFG.SFGINF_RENTABILIDAD_GetRentabilidadServicio;
GO

CREATE     PROCEDURE WSXML_SFG.SFGINF_RENTABILIDAD_GetRentabilidadServicio(@p_CODCICLOFACTURACIONPDV NUMERIC(22,0),
                                    @p_CODLINEADENEGOCIO      NUMERIC(22,0),
                                    @pg_CADENA                NVARCHAR(2000),
                                    @pg_ALIADOESTRATEGICO     NVARCHAR(2000),
                                    @pg_PRODUCTO              NVARCHAR(2000)) AS
 BEGIN
    DECLARE @sFECHACCLO DATETIME;
    DECLARE @sFECHAFRST DATETIME;
    DECLARE @sFECHALAST DATETIME;
    DECLARE @vTOTALMIXV FLOAT = 0;
   
  SET NOCOUNT ON;
    SELECT @sFECHACCLO = FECHAEJECUCION FROM WSXML_SFG.CICLOFACTURACIONPDV WHERE ID_CICLOFACTURACIONPDV = @p_CODCICLOFACTURACIONPDV;
    EXEC WSXML_SFG.SFG_PACKAGE_GetMonthRange @sFECHACCLO, @sFECHAFRST OUT, @sFECHALAST OUT
    -- Get total amount for % participation
    SELECT @vTOTALMIXV = SUM(CASE WHEN REG.CODTIPOREGISTRO IN (1, 3) THEN REG.NUMTRANSACCIONES
                    WHEN REG.CODTIPOREGISTRO = 2       THEN REG.NUMTRANSACCIONES * (-1) ELSE 0 END) FROM WSXML_SFG.ENTRADAARCHIVOCONTROL CTR
    INNER JOIN WSXML_SFG.REGISTROFACTURACION REG ON (REG.CODENTRADAARCHIVOCONTROL = CTR.ID_ENTRADAARCHIVOCONTROL)
    INNER JOIN WSXML_SFG.PRODUCTO            PRD ON (PRD.ID_PRODUCTO              = REG.CODPRODUCTO)
    INNER JOIN WSXML_SFG.TIPOPRODUCTO        TPR ON (TPR.ID_TIPOPRODUCTO          = PRD.CODTIPOPRODUCTO)
    WHERE CTR.REVERSADO = 0 AND CTR.FECHAARCHIVO BETWEEN @sFECHAFRST AND @sFECHALAST
      AND CTR.TIPOARCHIVO = @p_CODCICLOFACTURACIONPDV;
    -- Open cursor
         SELECT AGRUPACIONPUNTODEVENTA.CODIGOAGRUPACIONGTECH AS CODIGOAGRUPACIONGTECH,
             PUNTODEVENTA.CODIGOGTECHPUNTODEVENTA AS CODIGOGTECHPUNTODEVENTA,
             PUNTODEVENTA.NUMEROTERMINAL AS NUMEROTERMINAL,
             REDPDV.NOMREDPDV AS NOMREDPDV,
             TIPONEGOCIO.NOMTIPONEGOCIO AS NOMTIPONEGOCIO,
             REGIONAL.NOMREGIONAL        AS NOMREGIONAL,
             isnull(FMR.NOMFMR, ' ')                  AS NOMFMR,
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROFACTURACION.NUMTRANSACCIONES 
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  THEN REGISTROFACTURACION.NUMTRANSACCIONES *-1 
                       ELSE 0 END ), 4),0)                                                                                            AS NUMTRANSACCIONES,
             Isnull(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROFACTURACION.NUMTRANSACCIONES 
                                 WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (2) THEN REGISTROFACTURACION.NUMTRANSACCIONES *-1 
                                 ELSE 0 END )  * 100 / @vTOTALMIXV, 4),0)                                                          AS PRTTRANSACCIONES,                         
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROFACTURACION.VALORVENTABRUTA 
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  THEN REGISTROFACTURACION.VALORVENTABRUTA *-1 
                       ELSE 0 END ) , 4),0)                                                                                           AS INGRESOSBRUTOS,                                                                    

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN IMPUESTOS.IVA 
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  THEN IMPUESTOS.IVA *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS IVAPRODUCTO,                                                                    

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROFACTURACION.VALORDESCUENTOS 
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  THEN REGISTROFACTURACION.VALORDESCUENTOS *-1 
                       ELSE 0 END ) , 4),0)                                                                                           AS DESCUENTOS, 

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) 
                                AND REGISTROFACTURACION.COMISIONANTICIPO = 0  THEN REGISTROFACTURACION.VALORCOMISION 
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  
                                AND REGISTROFACTURACION.COMISIONANTICIPO = 0  THEN REGISTROFACTURACION.VALORCOMISION  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS COMISION,       
                                                                                      
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3)  THEN REGISTROREVENUE.REVENUEBASE
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)       THEN REGISTROREVENUE.REVENUEBASE  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS REVENUEBASE,                          


             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3)  THEN REVENUETRX.REVENUE
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)       THEN REVENUETRX.REVENUE  *-1 
                       ELSE 0 END ), 4),0)                                                                                      AS REVENUERANGOS,                          
                                                
                       
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3)  THEN REVENUEFIJO.REVENUE
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)       THEN REVENUEFIJO.REVENUE  *-1 
                       ELSE 0 END ), 4),0)                                                                                            AS REVENUEFIJO,           
                  
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3)  THEN REGISTROREVENUE.REVENUETOTAL
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)       THEN REGISTROREVENUE.REVENUETOTAL  *-1 
                       ELSE 0 END ), 4),0)                                                                                            AS REVENUETOTAL,                                
                         
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROREVENUE.INGRESOCORPORATIVO
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN REGISTROREVENUE.INGRESOCORPORATIVO  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS REVENUECORPORATIVO,                          

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROREVENUE.INGRESOLOCAL
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN REGISTROREVENUE.INGRESOLOCAL  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS REVENUELOCAL,                                                   

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROREVENUE.EGRESOLOCAL
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN REGISTROREVENUE.EGRESOLOCAL  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS COSTODEVENTA,                                                   

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO01
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO01  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS ICA,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO04
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO04  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS COMISIONETESA,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO02
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO02  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS INTERCOMPANY,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO03
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO03  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS ICAINTERCOMPANY,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO07
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO07  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS BADDEBTPROVISION,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) 
                           THEN ISNULL(COSTOSCALCULADOS.COSTO05,0)+ISNULL(COSTOSCALCULADOS.COSTO06,0)
                           WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      
                           THEN (ISNULL(COSTOSCALCULADOS.COSTO05,0)+ISNULL(COSTOSCALCULADOS.COSTO06,0))  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS MERCADEO,
                         
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO08
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO08  *-1 
                       ELSE 0 END ), 4),0)                                                                                       AS IVANODESCONTABLE,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO09
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO09  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS IC108,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO10
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO10  *-1 
                       ELSE 0 END ), 4),0)                                                                                        AS ICAIC108,
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO11
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO11  *-1 
                       ELSE 0 END ), 4),0)                                                                                        AS COSTOSINBIOMETRIA,
                         
                       ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO12
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO12  *-1 
                       ELSE 0 END ), 4),0)                                                                                        AS COSTOCONBIOMETRIA,
                         
                       ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO13
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO13  *-1 
                       ELSE 0 END ), 4),0)                                                                                       AS COSTOSINBIOMETRIACONSULTA,
                         
                       ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO14
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO14  *-1 
                       ELSE 0 END ), 4),0)                                                                                       AS COSTODATACREDITO,
                         
                       

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROREVENUE.UTILIDADPARCIAL
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN REGISTROREVENUE.UTILIDADPARCIAL  *-1 
                       ELSE 0 END ), 4),0)    AS  UTILIDADPARCIAL
      FROM WSXML_SFG.REGISTROREVENUE
      INNER JOIN WSXML_SFG.REGISTROFACTURACION ON REGISTROREVENUE.CODREGISTROFACTURACION = REGISTROFACTURACION.ID_REGISTROFACTURACION
      INNER JOIN WSXML_SFG.ENTRADAARCHIVOCONTROL ON REGISTROFACTURACION.CODENTRADAARCHIVOCONTROL = ENTRADAARCHIVOCONTROL.ID_ENTRADAARCHIVOCONTROL
      INNER JOIN WSXML_SFG.PUNTODEVENTA ON REGISTROFACTURACION.CODPUNTODEVENTA = PUNTODEVENTA.ID_PUNTODEVENTA
      INNER JOIN WSXML_SFG.AGRUPACIONPUNTODEVENTA ON REGISTROFACTURACION.CODAGRUPACIONPUNTODEVENTA = AGRUPACIONPUNTODEVENTA.ID_AGRUPACIONPUNTODEVENTA
      INNER JOIN WSXML_SFG.TIPONEGOCIO ON PUNTODEVENTA.CODTIPONEGOCIO = TIPONEGOCIO.ID_TIPONEGOCIO
      INNER JOIN WSXML_SFG.REGIONAL ON PUNTODEVENTA.CODREGIONAL = REGIONAL.ID_REGIONAL
      INNER JOIN WSXML_SFG.PRODUCTO ON REGISTROFACTURACION.CODPRODUCTO = PRODUCTO.ID_PRODUCTO 
      INNER JOIN WSXML_SFG.TIPOPRODUCTO ON PRODUCTO.CODTIPOPRODUCTO = TIPOPRODUCTO.ID_TIPOPRODUCTO      
      INNER JOIN WSXML_SFG.LINEADENEGOCIO ON TIPOPRODUCTO.CODLINEADENEGOCIO = LINEADENEGOCIO.ID_LINEADENEGOCIO
      LEFT OUTER JOIN WSXML_SFG.RUTAPDV ON PUNTODEVENTA.CODRUTAPDV = RUTAPDV.ID_RUTAPDV
      LEFT OUTER JOIN WSXML_SFG.FMR ON RUTAPDV.CODFMR = FMR.ID_FMR
      LEFT OUTER JOIN WSXML_SFG.REDPDV ON REGISTROFACTURACION.CODREDPDV = REDPDV.ID_REDPDV
      LEFT OUTER JOIN 
                      (
                      SELECT CODREGISTROFACTURACION,
                             SUM(CASE WHEN CODIMPUESTO = 1 THEN IMPUESTOREGFACTURACION.VALORIMPUESTO ELSE 0 END) AS IVA 
                      FROM WSXML_SFG.IMPUESTOREGFACTURACION
                      GROUP BY CODREGISTROFACTURACION 
                      )IMPUESTOS ON IMPUESTOS.CODREGISTROFACTURACION = REGISTROFACTURACION.ID_REGISTROFACTURACION
      LEFT OUTER JOIN (
                      SELECT CODREGISTROREVENUE, SUM(REVENUE) AS REVENUE
                      FROM WSXML_SFG.REGISTROREVENUETRANSACCION
                      GROUP BY CODREGISTROREVENUE
                      ) REVENUETRX ON REVENUETRX.CODREGISTROREVENUE = REGISTROREVENUE.ID_REGISTROREVENUE              
      LEFT OUTER JOIN (
                 SELECT CODREGISTROREVENUE, SUM(REVENUE) AS REVENUE
                 FROM WSXML_SFG.REGISTROREVENUEINCENTIVO
                 GROUP BY CODREGISTROREVENUE
                 ) REVENUEFIJO ON REVENUEFIJO.CODREGISTROREVENUE = REGISTROREVENUE.ID_REGISTROREVENUE
      LEFT OUTER JOIN (SELECT CODREGISTROREVENUE,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 41 OR CODCOSTOCALCULADO = 42 THEN VALORCOSTO ELSE 0 END) AS COSTO01,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 43 THEN VALORCOSTO ELSE 0 END) AS COSTO02,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 44 THEN VALORCOSTO ELSE 0 END) AS COSTO03,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 45 OR CODCOSTOCALCULADO = 46 THEN VALORCOSTO ELSE 0 END) AS COSTO04,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 47 THEN VALORCOSTO ELSE 0 END) AS COSTO05,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 48 THEN VALORCOSTO ELSE 0 END) AS COSTO06,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 49 OR CODCOSTOCALCULADO = 50 THEN VALORCOSTO ELSE 0 END) AS COSTO07,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 51 OR CODCOSTOCALCULADO = 54 THEN VALORCOSTO ELSE 0 END) AS COSTO08,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 52 THEN VALORCOSTO ELSE 0 END) AS COSTO09,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 53 THEN VALORCOSTO ELSE 0 END) AS COSTO10,
                        
                        SUM(CASE WHEN CODCOSTOCALCULADO=67 OR CODCOSTOCALCULADO=68 THEN VALORCOSTO ELSE 0 END) AS COSTO11, -- COSTO SIN BIOMETRIA
                        SUM(CASE WHEN CODCOSTOCALCULADO=65 OR CODCOSTOCALCULADO=66 THEN VALORCOSTO ELSE 0 END) AS COSTO12, -- COSTO CON BIOMETRIA
                        SUM(CASE WHEN CODCOSTOCALCULADO=71 OR CODCOSTOCALCULADO=72 THEN VALORCOSTO ELSE 0 END) AS COSTO13, -- COSTO CON BIOMETRIA CONSULTA
                        SUM(CASE WHEN CODCOSTOCALCULADO=69 OR CODCOSTOCALCULADO=70 THEN VALORCOSTO ELSE 0 END) AS COSTO14 -- COSTO DATACREDITO
                        
                 FROM WSXML_SFG.REGISTROREVCOSTOCALCULADO
                 GROUP BY CODREGISTROREVENUE) COSTOSCALCULADOS ON COSTOSCALCULADOS.CODREGISTROREVENUE = REGISTROREVENUE.ID_REGISTROREVENUE
      WHERE ENTRADAARCHIVOCONTROL.FECHAARCHIVO BETWEEN @sFECHAFRST AND @sFECHALAST
        AND LINEADENEGOCIO.CODSERVICIO = @p_CODLINEADENEGOCIO
          GROUP BY     AGRUPACIONPUNTODEVENTA.CODIGOAGRUPACIONGTECH,
             PUNTODEVENTA.CODIGOGTECHPUNTODEVENTA,
             PUNTODEVENTA.NUMEROTERMINAL,
             REDPDV.NOMREDPDV,
             TIPONEGOCIO.NOMTIPONEGOCIO,
             REGIONAL.NOMREGIONAL,
             FMR.NOMFMR       
      ORDER BY 1;
  END;
GO

IF OBJECT_ID('WSXML_SFG.SFGINF_RENTABILIDAD_GetRentabilidadServicioAcumula', 'P') IS NOT NULL
  DROP PROCEDURE WSXML_SFG.SFGINF_RENTABILIDAD_GetRentabilidadServicioAcumula;
GO

CREATE     PROCEDURE WSXML_SFG.SFGINF_RENTABILIDAD_GetRentabilidadServicioAcumula(@p_CODCICLOFACTURACIONPDV NUMERIC(22,0),
                                           @p_CODLINEADENEGOCIO      NUMERIC(22,0),
                                           @pg_CADENA                NVARCHAR(2000),
                                           @pg_ALIADOESTRATEGICO     NVARCHAR(2000),
                                           @pg_PRODUCTO              NVARCHAR(2000)) AS
 BEGIN
    DECLARE @sFECHACCLO DATETIME;
    DECLARE @sFECHAFRST DATETIME;
    DECLARE @sFECHALAST DATETIME;
    DECLARE @vTOTALMIXV FLOAT = 0;
   
  SET NOCOUNT ON;
    SELECT @sFECHACCLO = FECHAEJECUCION FROM WSXML_SFG.CICLOFACTURACIONPDV WHERE ID_CICLOFACTURACIONPDV = @p_CODCICLOFACTURACIONPDV;
    EXEC WSXML_SFG.SFG_PACKAGE_GetMonthRange @sFECHACCLO, @sFECHAFRST OUT, @sFECHALAST OUT
    -- Get total amount for % participation
    -- Get total amount for % participation
    SELECT @vTOTALMIXV = SUM(CASE WHEN REG.CODTIPOREGISTRO IN (1, 3) THEN REG.NUMTRANSACCIONES
                    WHEN REG.CODTIPOREGISTRO = 2       THEN REG.NUMTRANSACCIONES * (-1) ELSE 0 END) FROM WSXML_SFG.ENTRADAARCHIVOCONTROL CTR
    INNER JOIN WSXML_SFG.REGISTROFACTURACION REG ON (REG.CODENTRADAARCHIVOCONTROL = CTR.ID_ENTRADAARCHIVOCONTROL)
    INNER JOIN WSXML_SFG.PRODUCTO            PRD ON (PRD.ID_PRODUCTO              = REG.CODPRODUCTO)
    INNER JOIN WSXML_SFG.TIPOPRODUCTO        TPR ON (TPR.ID_TIPOPRODUCTO          = PRD.CODTIPOPRODUCTO)
    WHERE CTR.REVERSADO = 0 AND CTR.FECHAARCHIVO BETWEEN CONVERT(DATETIME,FORMAT(@sFECHAFRST, 'yyyy')+'-01-01',103) AND @sFECHALAST
      AND CTR.TIPOARCHIVO = @p_CODCICLOFACTURACIONPDV;
    -- Open cursor
           SELECT AGRUPACIONPUNTODEVENTA.CODIGOAGRUPACIONGTECH AS CODIGOAGRUPACIONGTECH,
             PUNTODEVENTA.CODIGOGTECHPUNTODEVENTA AS CODIGOGTECHPUNTODEVENTA,
             PUNTODEVENTA.NUMEROTERMINAL AS NUMEROTERMINAL,
             REDPDV.NOMREDPDV AS NOMREDPDV,
             TIPONEGOCIO.NOMTIPONEGOCIO AS NOMTIPONEGOCIO,
             REGIONAL.NOMREGIONAL        AS NOMREGIONAL,
             isnull(FMR.NOMFMR, ' ')                  AS NOMFMR,
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROFACTURACION.NUMTRANSACCIONES 
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  THEN REGISTROFACTURACION.NUMTRANSACCIONES *-1 
                       ELSE 0 END ), 4),0)                                                                                            AS NUMTRANSACCIONES,
             Isnull(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROFACTURACION.NUMTRANSACCIONES 
                                 WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (2) THEN REGISTROFACTURACION.NUMTRANSACCIONES *-1 
                                 ELSE 0 END )  * 100 / @vTOTALMIXV, 4),0)                                                          AS PRTTRANSACCIONES,                         
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROFACTURACION.VALORVENTABRUTA 
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  THEN REGISTROFACTURACION.VALORVENTABRUTA *-1 
                       ELSE 0 END ) , 4),0)                                                                                           AS INGRESOSBRUTOS,                                                                    

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN IMPUESTOS.IVA 
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  THEN IMPUESTOS.IVA *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS IVAPRODUCTO,                                                                    

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROFACTURACION.VALORDESCUENTOS 
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  THEN REGISTROFACTURACION.VALORDESCUENTOS *-1 
                       ELSE 0 END ) , 4),0)                                                                                           AS DESCUENTOS,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) 
                                AND REGISTROFACTURACION.COMISIONANTICIPO = 0  THEN REGISTROFACTURACION.VALORCOMISION 
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  
                                AND REGISTROFACTURACION.COMISIONANTICIPO = 0  THEN REGISTROFACTURACION.VALORCOMISION  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS COMISION,       
                                                                                      
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3)  THEN REGISTROREVENUE.REVENUEBASE
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)       THEN REGISTROREVENUE.REVENUEBASE  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS REVENUEBASE,                          


             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3)  THEN REVENUETRX.REVENUE
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)       THEN REVENUETRX.REVENUE  *-1 
                       ELSE 0 END ), 4),0)                                                                                      AS REVENUERANGOS,                          
                                                
                       
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3)  THEN REVENUEFIJO.REVENUE
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)       THEN REVENUEFIJO.REVENUE  *-1 
                       ELSE 0 END ), 4),0)                                                                                            AS REVENUEFIJO,           
                  
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3)  THEN REGISTROREVENUE.REVENUETOTAL
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)       THEN REGISTROREVENUE.REVENUETOTAL  *-1 
                       ELSE 0 END ), 4),0)                                                                                            AS REVENUETOTAL,                                
                         
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROREVENUE.INGRESOCORPORATIVO
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN REGISTROREVENUE.INGRESOCORPORATIVO  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS REVENUECORPORATIVO,                          

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROREVENUE.INGRESOLOCAL
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN REGISTROREVENUE.INGRESOLOCAL  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS REVENUELOCAL,                                                   

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROREVENUE.EGRESOLOCAL
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN REGISTROREVENUE.EGRESOLOCAL  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS COSTODEVENTA,                                                   

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO01
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO01  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS ICA,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO04
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO04  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS COMISIONETESA,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO02
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO02  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS INTERCOMPANY,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO03
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO03  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS ICAINTERCOMPANY,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO07
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO07  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS BADDEBTPROVISION,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) 
                           THEN ISNULL(COSTOSCALCULADOS.COSTO05,0)+ISNULL(COSTOSCALCULADOS.COSTO06,0)
                           WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      
                           THEN (ISNULL(COSTOSCALCULADOS.COSTO05,0)+ISNULL(COSTOSCALCULADOS.COSTO06,0))  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS MERCADEO,
                         
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO08
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO08  *-1 
                       ELSE 0 END ), 4),0)                                                                                       AS IVANODESCONTABLE,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO09
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO09  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS IC108,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO10
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO10  *-1 
                       ELSE 0 END ), 4),0)                                                                                        AS ICAIC108,
                         
                       ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO11
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO11  *-1 
                       ELSE 0 END ), 4),0)                                                                                        AS COSTOSINBIOMETRIA,
                         
                       ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO12
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO12  *-1 
                       ELSE 0 END ), 4),0)                                                                                        AS COSTOCONBIOMETRIA,
                         
                       ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO13
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO13  *-1 
                       ELSE 0 END ), 4),0)                                                                                       AS COSTOSINBIOMETRIACONSULTA,
                         
                       ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO14
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO14  *-1 
                       ELSE 0 END ), 4),0)                                                                                       AS COSTODATACREDITO,
                       
                       ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROREVENUE.UTILIDADPARCIAL
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN REGISTROREVENUE.UTILIDADPARCIAL  *-1 
                       ELSE 0 END ), 4),0)                                                                                        AS  UTILIDADPARCIAL
      FROM WSXML_SFG.REGISTROREVENUE
      INNER JOIN WSXML_SFG.REGISTROFACTURACION ON REGISTROREVENUE.CODREGISTROFACTURACION = REGISTROFACTURACION.ID_REGISTROFACTURACION
      INNER JOIN WSXML_SFG.ENTRADAARCHIVOCONTROL ON REGISTROFACTURACION.CODENTRADAARCHIVOCONTROL = ENTRADAARCHIVOCONTROL.ID_ENTRADAARCHIVOCONTROL
      INNER JOIN WSXML_SFG.PUNTODEVENTA ON REGISTROFACTURACION.CODPUNTODEVENTA = PUNTODEVENTA.ID_PUNTODEVENTA
      INNER JOIN WSXML_SFG.AGRUPACIONPUNTODEVENTA ON REGISTROFACTURACION.CODAGRUPACIONPUNTODEVENTA = AGRUPACIONPUNTODEVENTA.ID_AGRUPACIONPUNTODEVENTA
      INNER JOIN WSXML_SFG.TIPONEGOCIO ON PUNTODEVENTA.CODTIPONEGOCIO = TIPONEGOCIO.ID_TIPONEGOCIO
      INNER JOIN WSXML_SFG.REGIONAL ON PUNTODEVENTA.CODREGIONAL = REGIONAL.ID_REGIONAL
      INNER JOIN WSXML_SFG.PRODUCTO ON REGISTROFACTURACION.CODPRODUCTO = PRODUCTO.ID_PRODUCTO 
      INNER JOIN WSXML_SFG.TIPOPRODUCTO ON PRODUCTO.CODTIPOPRODUCTO = TIPOPRODUCTO.ID_TIPOPRODUCTO      
      INNER JOIN WSXML_SFG.LINEADENEGOCIO ON TIPOPRODUCTO.CODLINEADENEGOCIO = LINEADENEGOCIO.ID_LINEADENEGOCIO
      LEFT OUTER JOIN WSXML_SFG.RUTAPDV ON PUNTODEVENTA.CODRUTAPDV = RUTAPDV.ID_RUTAPDV
      LEFT OUTER JOIN WSXML_SFG.FMR ON RUTAPDV.CODFMR = FMR.ID_FMR
      LEFT OUTER JOIN WSXML_SFG.REDPDV ON REGISTROFACTURACION.CODREDPDV = REDPDV.ID_REDPDV
      LEFT OUTER JOIN 
                      (
                      SELECT CODREGISTROFACTURACION,
                             SUM(CASE WHEN CODIMPUESTO = 1 THEN IMPUESTOREGFACTURACION.VALORIMPUESTO ELSE 0 END) AS IVA 
                      FROM WSXML_SFG.IMPUESTOREGFACTURACION
                      GROUP BY CODREGISTROFACTURACION 
                      )IMPUESTOS ON IMPUESTOS.CODREGISTROFACTURACION = REGISTROFACTURACION.ID_REGISTROFACTURACION
      LEFT OUTER JOIN (
                      SELECT CODREGISTROREVENUE, SUM(REVENUE) AS REVENUE
                      FROM WSXML_SFG.REGISTROREVENUETRANSACCION
                      GROUP BY CODREGISTROREVENUE
                      ) REVENUETRX ON REVENUETRX.CODREGISTROREVENUE = REGISTROREVENUE.ID_REGISTROREVENUE              
      LEFT OUTER JOIN (
                 SELECT CODREGISTROREVENUE, SUM(REVENUE) AS REVENUE
                 FROM WSXML_SFG.REGISTROREVENUEINCENTIVO
                 GROUP BY CODREGISTROREVENUE
                 ) REVENUEFIJO ON REVENUEFIJO.CODREGISTROREVENUE = REGISTROREVENUE.ID_REGISTROREVENUE
      LEFT OUTER JOIN (SELECT CODREGISTROREVENUE,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 41 OR CODCOSTOCALCULADO = 42 THEN VALORCOSTO ELSE 0 END) AS COSTO01,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 43 THEN VALORCOSTO ELSE 0 END) AS COSTO02,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 44 THEN VALORCOSTO ELSE 0 END) AS COSTO03,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 45 OR CODCOSTOCALCULADO = 46 THEN VALORCOSTO ELSE 0 END) AS COSTO04,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 47 THEN VALORCOSTO ELSE 0 END) AS COSTO05,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 48 THEN VALORCOSTO ELSE 0 END) AS COSTO06,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 49 OR CODCOSTOCALCULADO = 50 THEN VALORCOSTO ELSE 0 END) AS COSTO07,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 51 OR CODCOSTOCALCULADO = 54 THEN VALORCOSTO ELSE 0 END) AS COSTO08,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 52 THEN VALORCOSTO ELSE 0 END) AS COSTO09,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 53 THEN VALORCOSTO ELSE 0 END) AS COSTO10,
                        SUM(CASE WHEN CODCOSTOCALCULADO=67 OR CODCOSTOCALCULADO=68 THEN VALORCOSTO ELSE 0 END) AS COSTO11, -- COSTO SIN BIOMETRIA
                        SUM(CASE WHEN CODCOSTOCALCULADO=65 OR CODCOSTOCALCULADO=66 THEN VALORCOSTO ELSE 0 END) AS COSTO12, -- COSTO CON BIOMETRIA
                        SUM(CASE WHEN CODCOSTOCALCULADO=71 OR CODCOSTOCALCULADO=72 THEN VALORCOSTO ELSE 0 END) AS COSTO13, -- COSTO CON BIOMETRIA CONSULTA
                        SUM(CASE WHEN CODCOSTOCALCULADO=69 OR CODCOSTOCALCULADO=70 THEN VALORCOSTO ELSE 0 END) AS COSTO14 -- COSTO DATACREDITO                        
                        
                 FROM WSXML_SFG.REGISTROREVCOSTOCALCULADO
                 GROUP BY CODREGISTROREVENUE) COSTOSCALCULADOS ON COSTOSCALCULADOS.CODREGISTROREVENUE = REGISTROREVENUE.ID_REGISTROREVENUE
      WHERE ENTRADAARCHIVOCONTROL.FECHAARCHIVO BETWEEN CONVERT(DATETIME,FORMAT(@sFECHAFRST, 'yyyy')+'-01-01',103) AND @sFECHALAST
        AND LINEADENEGOCIO.CODSERVICIO = @p_CODLINEADENEGOCIO
           GROUP BY     AGRUPACIONPUNTODEVENTA.CODIGOAGRUPACIONGTECH,
             PUNTODEVENTA.CODIGOGTECHPUNTODEVENTA,
             PUNTODEVENTA.NUMEROTERMINAL,
             REDPDV.NOMREDPDV,
             TIPONEGOCIO.NOMTIPONEGOCIO,
             REGIONAL.NOMREGIONAL,
             FMR.NOMFMR       
      ORDER BY 1;
  END;
GO
 
 
  IF OBJECT_ID('WSXML_SFG.SFGINF_RENTABILIDAD_GetRentabilidadProducto', 'P') IS NOT NULL
  DROP PROCEDURE WSXML_SFG.SFGINF_RENTABILIDAD_GetRentabilidadProducto;
GO

CREATE     PROCEDURE WSXML_SFG.SFGINF_RENTABILIDAD_GetRentabilidadProducto(@p_CODCICLOFACTURACIONPDV NUMERIC(22,0),
                                    @p_CODLINEADENEGOCIO      NUMERIC(22,0),
                                    @pg_CADENA                NVARCHAR(2000),
                                    @pg_ALIADOESTRATEGICO     NVARCHAR(2000),
                                    @pg_PRODUCTO              NVARCHAR(2000)) AS
 BEGIN
    DECLARE @sFECHACCLO DATETIME;
    DECLARE @sFECHAFRST DATETIME;
    DECLARE @sFECHALAST DATETIME;
    DECLARE @vTOTALMIXV FLOAT = 0;
    DECLARE @vIDPRODUCTO NUMERIC(22,0);
   
  SET NOCOUNT ON;
    SELECT @sFECHACCLO = FECHAEJECUCION FROM WSXML_SFG.CICLOFACTURACIONPDV WHERE ID_CICLOFACTURACIONPDV = @p_CODCICLOFACTURACIONPDV;
    EXEC WSXML_SFG.SFG_PACKAGE_GetMonthRange @sFECHACCLO, @sFECHAFRST OUT, @sFECHALAST OUT
    -- Get total amount for % participation
    SELECT @vTOTALMIXV = SUM(CASE WHEN REG.CODTIPOREGISTRO IN (1, 3) THEN REG.NUMTRANSACCIONES
                    WHEN REG.CODTIPOREGISTRO = 2       THEN REG.NUMTRANSACCIONES * (-1) ELSE 0 END) FROM WSXML_SFG.ENTRADAARCHIVOCONTROL CTR
    INNER JOIN WSXML_SFG.REGISTROFACTURACION REG ON (REG.CODENTRADAARCHIVOCONTROL = CTR.ID_ENTRADAARCHIVOCONTROL)
    WHERE CTR.REVERSADO = 0 AND CTR.FECHAARCHIVO BETWEEN @sFECHAFRST AND @sFECHALAST
      AND REG.CODPRODUCTO = WSXML_SFG.PRODUCTO_F(@pg_PRODUCTO);
      
    SET @vIDPRODUCTO=WSXML_SFG.PRODUCTO_F(@pg_PRODUCTO);      
    -- Open cursor
          SELECT AGRUPACIONPUNTODEVENTA.CODIGOAGRUPACIONGTECH AS CODIGOAGRUPACIONGTECH,
             PUNTODEVENTA.CODIGOGTECHPUNTODEVENTA AS CODIGOGTECHPUNTODEVENTA,
             PUNTODEVENTA.NUMEROTERMINAL AS NUMEROTERMINAL,
             REDPDV.NOMREDPDV AS NOMREDPDV,
             TIPONEGOCIO.NOMTIPONEGOCIO AS NOMTIPONEGOCIO,
             REGIONAL.NOMREGIONAL        AS NOMREGIONAL,
             isnull(FMR.NOMFMR, ' ')                  AS NOMFMR,
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROFACTURACION.NUMTRANSACCIONES 
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  THEN REGISTROFACTURACION.NUMTRANSACCIONES *-1 
                       ELSE 0 END ), 4),0)                                                                                            AS NUMTRANSACCIONES,
             Isnull(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROFACTURACION.NUMTRANSACCIONES 
                                 WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (2) THEN REGISTROFACTURACION.NUMTRANSACCIONES *-1 
                                 ELSE 0 END )  * 100 / @vTOTALMIXV, 4),0)                                                          AS PRTTRANSACCIONES,                         
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROFACTURACION.VALORVENTABRUTA 
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  THEN REGISTROFACTURACION.VALORVENTABRUTA *-1 
                       ELSE 0 END ) , 4),0)                                                                                           AS INGRESOSBRUTOS,                                                                    

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN IMPUESTOS.IVA 
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  THEN IMPUESTOS.IVA *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS IVAPRODUCTO,
                         
            ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROFACTURACION.VALORDESCUENTOS 
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  THEN REGISTROFACTURACION.VALORDESCUENTOS *-1 
                       ELSE 0 END ) , 4),0)                                                                                           AS DESCUENTOS,                       
                                                                                           

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) 
                                AND REGISTROFACTURACION.COMISIONANTICIPO = 0  THEN REGISTROFACTURACION.VALORCOMISION 
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  
                                AND REGISTROFACTURACION.COMISIONANTICIPO = 0  THEN REGISTROFACTURACION.VALORCOMISION  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS COMISION,       
                                                                                      
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3)  THEN REGISTROREVENUE.REVENUEBASE
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)       THEN REGISTROREVENUE.REVENUEBASE  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS REVENUEBASE,                          


             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3)  THEN REVENUETRX.REVENUE
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)       THEN REVENUETRX.REVENUE  *-1 
                       ELSE 0 END ), 4),0)                                                                                      AS REVENUERANGOS,                          
                                                
                       
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3)  THEN REVENUEFIJO.REVENUE
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)       THEN REVENUEFIJO.REVENUE  *-1 
                       ELSE 0 END ), 4),0)                                                                                            AS REVENUEFIJO,           
                  
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3)  THEN REGISTROREVENUE.REVENUETOTAL
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)       THEN REGISTROREVENUE.REVENUETOTAL  *-1 
                       ELSE 0 END ), 4),0)                                                                                            AS REVENUETOTAL,                                
                         
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROREVENUE.INGRESOCORPORATIVO
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN REGISTROREVENUE.INGRESOCORPORATIVO  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS REVENUECORPORATIVO,                          

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROREVENUE.INGRESOLOCAL
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN REGISTROREVENUE.INGRESOLOCAL  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS REVENUELOCAL,                                                   

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROREVENUE.EGRESOLOCAL
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN REGISTROREVENUE.EGRESOLOCAL  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS COSTODEVENTA,                                                   

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO01
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO01  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS ICA,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO04
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO04  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS COMISIONETESA,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO02
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO02  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS INTERCOMPANY,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO03
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO03  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS ICAINTERCOMPANY,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO07
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO07  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS BADDEBTPROVISION,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) 
                           THEN ISNULL(COSTOSCALCULADOS.COSTO05,0)+ISNULL(COSTOSCALCULADOS.COSTO06,0)
                           WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      
                           THEN (ISNULL(COSTOSCALCULADOS.COSTO05,0)+ISNULL(COSTOSCALCULADOS.COSTO06,0))  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS MERCADEO,
                         
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO08
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO08  *-1 
                       ELSE 0 END ), 4),0)                                                                                       AS IVANODESCONTABLE,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO09
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO09  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS IC108,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO10
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO10  *-1 
                       ELSE 0 END ), 4),0)                                                                                        AS ICAIC108,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO11
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO11  *-1 
                       ELSE 0 END ), 4),0)                                                                                        AS COSTOSINBIOMETRIA,
                         
                       ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO12
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO12  *-1 
                       ELSE 0 END ), 4),0)                                                                                        AS COSTOCONBIOMETRIA,
                         
                       ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO13
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO13  *-1 
                       ELSE 0 END ), 4),0)                                                                                        AS COSTOSINBIOMETRIACONSULTA,
                         
                       ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO14
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO14  *-1 
                       ELSE 0 END ), 4),0)                                                                                        AS COSTODATACREDITO,
                          
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROREVENUE.UTILIDADPARCIAL
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN REGISTROREVENUE.UTILIDADPARCIAL  *-1 
                       ELSE 0 END ), 4),0)                                                                                        AS  UTILIDADPARCIAL
      
      FROM WSXML_SFG.REGISTROREVENUE
      INNER JOIN WSXML_SFG.REGISTROFACTURACION ON REGISTROREVENUE.CODREGISTROFACTURACION = REGISTROFACTURACION.ID_REGISTROFACTURACION
      INNER JOIN WSXML_SFG.ENTRADAARCHIVOCONTROL ON REGISTROFACTURACION.CODENTRADAARCHIVOCONTROL = ENTRADAARCHIVOCONTROL.ID_ENTRADAARCHIVOCONTROL
      INNER JOIN WSXML_SFG.PUNTODEVENTA ON REGISTROFACTURACION.CODPUNTODEVENTA = PUNTODEVENTA.ID_PUNTODEVENTA
      INNER JOIN WSXML_SFG.AGRUPACIONPUNTODEVENTA ON REGISTROFACTURACION.CODAGRUPACIONPUNTODEVENTA = AGRUPACIONPUNTODEVENTA.ID_AGRUPACIONPUNTODEVENTA
      INNER JOIN WSXML_SFG.TIPONEGOCIO ON PUNTODEVENTA.CODTIPONEGOCIO = TIPONEGOCIO.ID_TIPONEGOCIO
      INNER JOIN WSXML_SFG.REGIONAL ON PUNTODEVENTA.CODREGIONAL = REGIONAL.ID_REGIONAL
      INNER JOIN WSXML_SFG.PRODUCTO ON REGISTROFACTURACION.CODPRODUCTO = PRODUCTO.ID_PRODUCTO 
      INNER JOIN WSXML_SFG.TIPOPRODUCTO ON PRODUCTO.CODTIPOPRODUCTO = TIPOPRODUCTO.ID_TIPOPRODUCTO      
      LEFT OUTER JOIN WSXML_SFG.RUTAPDV ON PUNTODEVENTA.CODRUTAPDV = RUTAPDV.ID_RUTAPDV
      LEFT OUTER JOIN WSXML_SFG.FMR ON RUTAPDV.CODFMR = FMR.ID_FMR
      LEFT OUTER JOIN WSXML_SFG.REDPDV ON REGISTROFACTURACION.CODREDPDV = REDPDV.ID_REDPDV
      LEFT OUTER JOIN 
                      (
                      SELECT CODREGISTROFACTURACION,
                             SUM(CASE WHEN CODIMPUESTO = 1 THEN IMPUESTOREGFACTURACION.VALORIMPUESTO ELSE 0 END) AS IVA 
                      FROM WSXML_SFG.IMPUESTOREGFACTURACION
                      GROUP BY CODREGISTROFACTURACION 
                      )IMPUESTOS ON IMPUESTOS.CODREGISTROFACTURACION = REGISTROFACTURACION.ID_REGISTROFACTURACION
      LEFT OUTER JOIN (
                      SELECT CODREGISTROREVENUE, SUM(REVENUE) AS REVENUE
                      FROM WSXML_SFG.REGISTROREVENUETRANSACCION
                      GROUP BY CODREGISTROREVENUE
                      ) REVENUETRX ON REVENUETRX.CODREGISTROREVENUE = REGISTROREVENUE.ID_REGISTROREVENUE              
      LEFT OUTER JOIN (
                 SELECT CODREGISTROREVENUE, SUM(REVENUE) AS REVENUE
                 FROM WSXML_SFG.REGISTROREVENUEINCENTIVO
                 GROUP BY CODREGISTROREVENUE
                 ) REVENUEFIJO ON REVENUEFIJO.CODREGISTROREVENUE = REGISTROREVENUE.ID_REGISTROREVENUE
      LEFT OUTER JOIN (SELECT CODREGISTROREVENUE,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 41 OR CODCOSTOCALCULADO = 42 THEN VALORCOSTO ELSE 0 END) AS COSTO01,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 43 THEN VALORCOSTO ELSE 0 END) AS COSTO02,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 44 THEN VALORCOSTO ELSE 0 END) AS COSTO03,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 45 OR CODCOSTOCALCULADO = 46 THEN VALORCOSTO ELSE 0 END) AS COSTO04,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 47 THEN VALORCOSTO ELSE 0 END) AS COSTO05,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 48 THEN VALORCOSTO ELSE 0 END) AS COSTO06,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 49 OR CODCOSTOCALCULADO = 50 THEN VALORCOSTO ELSE 0 END) AS COSTO07,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 51 OR CODCOSTOCALCULADO = 54 THEN VALORCOSTO ELSE 0 END) AS COSTO08,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 52 THEN VALORCOSTO ELSE 0 END) AS COSTO09,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 53 THEN VALORCOSTO ELSE 0 END) AS COSTO10,
                        SUM(CASE WHEN CODCOSTOCALCULADO=67 OR CODCOSTOCALCULADO=68 THEN VALORCOSTO ELSE 0 END) AS COSTO11, -- COSTO SIN BIOMETRIA
                        SUM(CASE WHEN CODCOSTOCALCULADO=65 OR CODCOSTOCALCULADO=66 THEN VALORCOSTO ELSE 0 END) AS COSTO12, -- COSTO CON BIOMETRIA
                        SUM(CASE WHEN CODCOSTOCALCULADO=71 OR CODCOSTOCALCULADO=72 THEN VALORCOSTO ELSE 0 END) AS COSTO13, -- COSTO CON BIOMETRIA CONSULTA
                        SUM(CASE WHEN CODCOSTOCALCULADO=69 OR CODCOSTOCALCULADO=70 THEN VALORCOSTO ELSE 0 END) AS COSTO14 -- COSTO DATACREDITO
                 FROM WSXML_SFG.REGISTROREVCOSTOCALCULADO
                 GROUP BY CODREGISTROREVENUE) COSTOSCALCULADOS ON COSTOSCALCULADOS.CODREGISTROREVENUE = REGISTROREVENUE.ID_REGISTROREVENUE
      WHERE ENTRADAARCHIVOCONTROL.FECHAARCHIVO BETWEEN @sFECHAFRST AND @sFECHALAST
--        AND TIPOPRODUCTO.CODLINEADENEGOCIO = p_CODLINEADENEGOCIO
        AND REGISTROFACTURACION.CODPRODUCTO       = @vIDPRODUCTO
           GROUP BY     AGRUPACIONPUNTODEVENTA.CODIGOAGRUPACIONGTECH,
             PUNTODEVENTA.CODIGOGTECHPUNTODEVENTA,
             PUNTODEVENTA.NUMEROTERMINAL,
             REDPDV.NOMREDPDV,
             TIPONEGOCIO.NOMTIPONEGOCIO,
             REGIONAL.NOMREGIONAL,
             FMR.NOMFMR       
      ORDER BY 1;
  END;
  GO

  
  IF OBJECT_ID('WSXML_SFG.SFGINF_RENTABILIDAD_GetRentabilidadProductoAcumula', 'P') IS NOT NULL
  DROP PROCEDURE WSXML_SFG.SFGINF_RENTABILIDAD_GetRentabilidadProductoAcumula;
GO

CREATE     PROCEDURE WSXML_SFG.SFGINF_RENTABILIDAD_GetRentabilidadProductoAcumula(@p_CODCICLOFACTURACIONPDV NUMERIC(22,0),
                                           @p_CODLINEADENEGOCIO      NUMERIC(22,0),
                                           @pg_CADENA                NVARCHAR(2000),
                                           @pg_ALIADOESTRATEGICO     NVARCHAR(2000),
                                           @pg_PRODUCTO              NVARCHAR(2000)) AS
 BEGIN
    DECLARE @sFECHACCLO DATETIME;
    DECLARE @sFECHAFRST DATETIME;
    DECLARE @sFECHALAST DATETIME;
    DECLARE @vTOTALMIXV FLOAT = 0;
    DECLARE @vIDPRODUCTO NUMERIC(22,0);
   
  SET NOCOUNT ON;
    SELECT @sFECHACCLO = FECHAEJECUCION FROM WSXML_SFG.CICLOFACTURACIONPDV WHERE ID_CICLOFACTURACIONPDV = @p_CODCICLOFACTURACIONPDV;
    EXEC WSXML_SFG.SFG_PACKAGE_GetMonthRange @sFECHACCLO, @sFECHAFRST OUT, @sFECHALAST OUT
    -- Get total amount for % participation
    SELECT @vTOTALMIXV = SUM(CASE WHEN REG.CODTIPOREGISTRO IN (1, 3) THEN REG.NUMTRANSACCIONES
                    WHEN REG.CODTIPOREGISTRO = 2       THEN REG.NUMTRANSACCIONES * (-1) ELSE 0 END) FROM WSXML_SFG.ENTRADAARCHIVOCONTROL CTR
    INNER JOIN REGISTROFACTURACION REG ON (REG.CODENTRADAARCHIVOCONTROL = CTR.ID_ENTRADAARCHIVOCONTROL)
    WHERE CTR.REVERSADO = 0 AND CTR.FECHAARCHIVO BETWEEN CONVERT(DATETIME,FORMAT(@sFECHAFRST, 'yyyy')+'-01-01',103) AND @sFECHALAST
      AND REG.CODPRODUCTO = WSXML_SFG.PRODUCTO_F(@pg_PRODUCTO);

    SET @vIDPRODUCTO=WSXML_SFG.PRODUCTO_F(@pg_PRODUCTO);           
      
    -- Open cursor
            SELECT AGRUPACIONPUNTODEVENTA.CODIGOAGRUPACIONGTECH AS CODIGOAGRUPACIONGTECH,
             PUNTODEVENTA.CODIGOGTECHPUNTODEVENTA AS CODIGOGTECHPUNTODEVENTA,
             PUNTODEVENTA.NUMEROTERMINAL AS NUMEROTERMINAL,
             REDPDV.NOMREDPDV AS NOMREDPDV,
             TIPONEGOCIO.NOMTIPONEGOCIO AS NOMTIPONEGOCIO,
             REGIONAL.NOMREGIONAL        AS NOMREGIONAL,
             isnull(FMR.NOMFMR, ' ')                  AS NOMFMR,
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROFACTURACION.NUMTRANSACCIONES 
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  THEN REGISTROFACTURACION.NUMTRANSACCIONES *-1 
                       ELSE 0 END ), 4),0)                                                                                            AS NUMTRANSACCIONES,
             Isnull(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROFACTURACION.NUMTRANSACCIONES 
                                 WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (2) THEN REGISTROFACTURACION.NUMTRANSACCIONES *-1 
                                 ELSE 0 END )  * 100 / @vTOTALMIXV, 4),0)                                                          AS PRTTRANSACCIONES,                         
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROFACTURACION.VALORVENTABRUTA 
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  THEN REGISTROFACTURACION.VALORVENTABRUTA *-1 
                       ELSE 0 END ) , 4),0)                                                                                           AS INGRESOSBRUTOS,                                                                    

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN IMPUESTOS.IVA 
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  THEN IMPUESTOS.IVA *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS IVAPRODUCTO, 
                         
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROFACTURACION.VALORDESCUENTOS 
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  THEN REGISTROFACTURACION.VALORDESCUENTOS *-1 
                       ELSE 0 END ) , 4),0)                                                                                           AS DESCUENTOS,                                                                             

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) 
                                AND REGISTROFACTURACION.COMISIONANTICIPO = 0  THEN REGISTROFACTURACION.VALORCOMISION 
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)  
                                AND REGISTROFACTURACION.COMISIONANTICIPO = 0  THEN REGISTROFACTURACION.VALORCOMISION  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS COMISION,       
                                                                                      
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3)  THEN REGISTROREVENUE.REVENUEBASE
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)       THEN REGISTROREVENUE.REVENUEBASE  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS REVENUEBASE,                          


             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3)  THEN REVENUETRX.REVENUE
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)       THEN REVENUETRX.REVENUE  *-1 
                       ELSE 0 END ), 4),0)                                                                                      AS REVENUERANGOS,                          
                                                
                       
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3)  THEN REVENUEFIJO.REVENUE
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)       THEN REVENUEFIJO.REVENUE  *-1 
                       ELSE 0 END ), 4),0)                                                                                            AS REVENUEFIJO,           
                  
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3)  THEN REGISTROREVENUE.REVENUETOTAL
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)       THEN REGISTROREVENUE.REVENUETOTAL  *-1 
                       ELSE 0 END ), 4),0)                                                                                            AS REVENUETOTAL,                                
                         
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROREVENUE.INGRESOCORPORATIVO
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN REGISTROREVENUE.INGRESOCORPORATIVO  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS REVENUECORPORATIVO,                          

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROREVENUE.INGRESOLOCAL
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN REGISTROREVENUE.INGRESOLOCAL  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS REVENUELOCAL,                                                   

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROREVENUE.EGRESOLOCAL
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN REGISTROREVENUE.EGRESOLOCAL  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS COSTODEVENTA,                                                   

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO01
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO01  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS ICA,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO04
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO04  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS COMISIONETESA,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO02
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO02  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS INTERCOMPANY,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO03
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO03  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS ICAINTERCOMPANY,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO07
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO07  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS BADDEBTPROVISION,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) 
                           THEN ISNULL(COSTOSCALCULADOS.COSTO05,0)+ISNULL(COSTOSCALCULADOS.COSTO06,0)
                           WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      
                           THEN (ISNULL(COSTOSCALCULADOS.COSTO05,0)+ISNULL(COSTOSCALCULADOS.COSTO06,0))  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS MERCADEO,
                         
             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO08
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO08  *-1 
                       ELSE 0 END ), 4),0)                                                                                       AS IVANODESCONTABLE,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO09
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO09  *-1 
                       ELSE 0 END ), 4),0)                                                                                           AS IC108,

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO10
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO10  *-1 
                       ELSE 0 END ), 4),0)                                                                                        AS ICAIC108,
                         
                       ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO11
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO11  *-1 
                       ELSE 0 END ), 4),0)                                                                                        AS COSTOSINBIOMETRIA,
                         
                       ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO12
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO12  *-1 
                       ELSE 0 END ), 4),0)                                                                                        AS COSTOCONBIOMETRIA,
                         
                       ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO13
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO13  *-1 
                       ELSE 0 END ), 4),0)                                                                                        AS COSTOSINBIOMETRIACONSULTA,
                         
                       ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN COSTOSCALCULADOS.COSTO14
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN COSTOSCALCULADOS.COSTO14  *-1 
                       ELSE 0 END ), 4),0)                                                                                        AS COSTODATACREDITO,
                         

             ISNULL(ROUND(SUM( CASE WHEN REGISTROFACTURACION.CODTIPOREGISTRO IN (1,3) THEN REGISTROREVENUE.UTILIDADPARCIAL
                       WHEN REGISTROFACTURACION.CODTIPOREGISTRO  IN (2)      THEN REGISTROREVENUE.UTILIDADPARCIAL  *-1 
                       ELSE 0 END ), 4),0)                                                                                          AS UTILIDADPARCIAL
      FROM WSXML_SFG.REGISTROREVENUE
      INNER JOIN WSXML_SFG.REGISTROFACTURACION ON REGISTROREVENUE.CODREGISTROFACTURACION = REGISTROFACTURACION.ID_REGISTROFACTURACION
      INNER JOIN WSXML_SFG.ENTRADAARCHIVOCONTROL ON REGISTROFACTURACION.CODENTRADAARCHIVOCONTROL = ENTRADAARCHIVOCONTROL.ID_ENTRADAARCHIVOCONTROL
      INNER JOIN WSXML_SFG.PUNTODEVENTA ON REGISTROFACTURACION.CODPUNTODEVENTA = PUNTODEVENTA.ID_PUNTODEVENTA
      INNER JOIN WSXML_SFG.AGRUPACIONPUNTODEVENTA ON REGISTROFACTURACION.CODAGRUPACIONPUNTODEVENTA = AGRUPACIONPUNTODEVENTA.ID_AGRUPACIONPUNTODEVENTA
      INNER JOIN WSXML_SFG.TIPONEGOCIO ON PUNTODEVENTA.CODTIPONEGOCIO = TIPONEGOCIO.ID_TIPONEGOCIO
      INNER JOIN WSXML_SFG.REGIONAL ON PUNTODEVENTA.CODREGIONAL = REGIONAL.ID_REGIONAL
      INNER JOIN WSXML_SFG.PRODUCTO ON REGISTROFACTURACION.CODPRODUCTO = PRODUCTO.ID_PRODUCTO 
      INNER JOIN WSXML_SFG.TIPOPRODUCTO ON PRODUCTO.CODTIPOPRODUCTO = TIPOPRODUCTO.ID_TIPOPRODUCTO      
      LEFT OUTER JOIN WSXML_SFG.RUTAPDV ON PUNTODEVENTA.CODRUTAPDV = RUTAPDV.ID_RUTAPDV
      LEFT OUTER JOIN WSXML_SFG.FMR ON RUTAPDV.CODFMR = FMR.ID_FMR
      LEFT OUTER JOIN WSXML_SFG.REDPDV ON REGISTROFACTURACION.CODREDPDV = REDPDV.ID_REDPDV
      LEFT OUTER JOIN 
                      (
                      SELECT CODREGISTROFACTURACION,
                             SUM(CASE WHEN CODIMPUESTO = 1 THEN IMPUESTOREGFACTURACION.VALORIMPUESTO ELSE 0 END) AS IVA 
                      FROM WSXML_SFG.IMPUESTOREGFACTURACION
                      GROUP BY CODREGISTROFACTURACION 
                      )IMPUESTOS ON IMPUESTOS.CODREGISTROFACTURACION = REGISTROFACTURACION.ID_REGISTROFACTURACION
      LEFT OUTER JOIN (
                      SELECT CODREGISTROREVENUE, SUM(REVENUE) AS REVENUE
                      FROM WSXML_SFG.REGISTROREVENUETRANSACCION
                      GROUP BY CODREGISTROREVENUE
                      ) REVENUETRX ON REVENUETRX.CODREGISTROREVENUE = REGISTROREVENUE.ID_REGISTROREVENUE              
      LEFT OUTER JOIN (
                 SELECT CODREGISTROREVENUE, SUM(REVENUE) AS REVENUE
                 FROM WSXML_SFG.REGISTROREVENUEINCENTIVO
                 GROUP BY CODREGISTROREVENUE
                 ) REVENUEFIJO ON REVENUEFIJO.CODREGISTROREVENUE = REGISTROREVENUE.ID_REGISTROREVENUE
      LEFT OUTER JOIN (SELECT CODREGISTROREVENUE,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 41 OR CODCOSTOCALCULADO = 42 THEN VALORCOSTO ELSE 0 END) AS COSTO01,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 43 THEN VALORCOSTO ELSE 0 END) AS COSTO02,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 44 THEN VALORCOSTO ELSE 0 END) AS COSTO03,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 45 OR CODCOSTOCALCULADO = 46 THEN VALORCOSTO ELSE 0 END) AS COSTO04,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 47 THEN VALORCOSTO ELSE 0 END) AS COSTO05,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 48 THEN VALORCOSTO ELSE 0 END) AS COSTO06,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 49 OR CODCOSTOCALCULADO = 50 THEN VALORCOSTO ELSE 0 END) AS COSTO07,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 51 OR CODCOSTOCALCULADO = 54 THEN VALORCOSTO ELSE 0 END) AS COSTO08,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 52 THEN VALORCOSTO ELSE 0 END) AS COSTO09,
                        SUM(CASE WHEN CODCOSTOCALCULADO = 53 THEN VALORCOSTO ELSE 0 END) AS COSTO10,
                        SUM(CASE WHEN CODCOSTOCALCULADO=67 OR CODCOSTOCALCULADO=68 THEN VALORCOSTO ELSE 0 END) AS COSTO11, -- COSTO SIN BIOMETRIA
                        SUM(CASE WHEN CODCOSTOCALCULADO=65 OR CODCOSTOCALCULADO=66 THEN VALORCOSTO ELSE 0 END) AS COSTO12, -- COSTO CON BIOMETRIA
                        SUM(CASE WHEN CODCOSTOCALCULADO=71 OR CODCOSTOCALCULADO=72 THEN VALORCOSTO ELSE 0 END) AS COSTO13, -- COSTO CON BIOMETRIA CONSULTA
                        SUM(CASE WHEN CODCOSTOCALCULADO=69 OR CODCOSTOCALCULADO=70 THEN VALORCOSTO ELSE 0 END) AS COSTO14 -- COSTO DATACREDITO
                        
                 FROM WSXML_SFG.REGISTROREVCOSTOCALCULADO
                 GROUP BY CODREGISTROREVENUE) COSTOSCALCULADOS ON COSTOSCALCULADOS.CODREGISTROREVENUE = REGISTROREVENUE.ID_REGISTROREVENUE
      WHERE ENTRADAARCHIVOCONTROL.FECHAARCHIVO BETWEEN CONVERT(DATETIME,FORMAT(@sFECHAFRST, 'yyyy')+'-01-01',103) AND @sFECHALAST
--        AND TIPOPRODUCTO.CODLINEADENEGOCIO = p_CODLINEADENEGOCIO
        AND REGISTROFACTURACION.CODPRODUCTO       =@vIDPRODUCTO
           GROUP BY     AGRUPACIONPUNTODEVENTA.CODIGOAGRUPACIONGTECH,
             PUNTODEVENTA.CODIGOGTECHPUNTODEVENTA,
             PUNTODEVENTA.NUMEROTERMINAL,
             REDPDV.NOMREDPDV,
             TIPONEGOCIO.NOMTIPONEGOCIO,
             REGIONAL.NOMREGIONAL,
             FMR.NOMFMR       
      ORDER BY 1;
  END;
GO